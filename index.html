<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Personal Finance Coach</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Raleway:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* ************************ Chatbot Styles ************************ */
        .chat-container {
            max-width: 500px;
            margin: 0 auto;
            border-radius: 16px;
            overflow: hidden;
            background: rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.18);
            transition: all 0.2s ease-in-out;
        }

        .news-container {
            max-width: 500px;
            margin: 0 auto;
            border-radius: 16px;
            overflow: hidden;
            background: rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.18);
            transition: all 0.2s ease-in-out;
        }

        .chat-container:hover {
            box-shadow: 0 8px 16px rgba(26, 129, 232, 0.525), 0 0 20px rgba(66, 185, 244, 0.483);
            transform: translateY(-5px);
        }

        .news-container:hover {
            box-shadow: 0 8px 16px rgba(26, 129, 232, 0.525), 0 0 20px rgba(66, 185, 244, 0.483);
            transform: translateY(-5px);
        }

        .chat-messages {
            height: 350px;
            overflow-y: auto;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            scrollbar-width: thin; /* Make scrollbar smaller */
            scrollbar-color: rgba(59, 130, 246, 0.8) transparent; /* Customize scrollbar color */
        }

        .chat-messages::-webkit-scrollbar {
            width: 8px; /* Make scrollbar smaller */
            padding-right: 10px;
        }

        .chat-messages::-webkit-scrollbar-thumb {
            background-color: rgba(59, 130, 246, 0.8); /* Customize scrollbar thumb color */
            border-radius: 4px;
        }

        .chat-messages::-webkit-scrollbar-track {
            background: transparent; /* Customize scrollbar track color */
        }

        .chat-input {
            display: flex;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
        }

        .chat-input input {
            flex: 1;
            padding: 0.5rem;
            border: none;
            outline: none;
            background: rgba(255, 255, 255, 0.2);
            color: #fff;
            border-radius: 8px;
        }

        .chat-input button {
            padding: 0.5rem 1rem;
            background-color: rgba(59, 130, 246, 0.8);
            color: white;
            border: none;
            cursor: pointer;
            border-radius: 8px;
        }

        .chat-input button:hover {
            background-color: rgba(37, 100, 235, 0.8);
        }

        .b1:hover {
            background-color: #002ca5d4;
        }

        .b2:hover {
            background-color: #002ca5d4;
        }

        button {
            transition: transform 0.2s ease, opacity 0.2s ease;
        }

        button:active {
            transform: scale(0.95);
            opacity: 0.8;
        }

        /* ************************ General Styles ************************ */
        body {
            font-family: 'Raleway', sans-serif; /* Modern and elegant font */
            background: linear-gradient(270deg, #a1c4fd, #c2e9fb, #ecc2fb, #a6c1ee);
            /* background-color: aliceblue; */
            background-size: 800% 800%;
            animation: gradientAnimation 10s ease infinite;
        }

        .container{
            max-width: 1200px;
            min-width: none;
            margin: 0 auto;
            padding: 20px;
        }

        @keyframes gradientAnimation {
            0% {
                background-position: 0% 50%;
            }

            50% {
                background-position: 100% 50%;
            }

            100% {
                background-position: 0% 50%;
            }
        }

        

        .glowing-hr {
            height: 3px;
            border: none;
            background: linear-gradient(90deg, rgb(0, 234, 255), rgb(255, 21, 165), rgba(103, 0, 241, 1), rgb(4, 188, 136), rgb(0, 234, 255), rgb(255, 21, 165), rgba(103, 0, 241, 1), rgb(0, 255, 174));
            background-size: 400% 400%;
            animation: glowing 4s linear infinite;
        }

        /* ************************ Navbar Styles ************************ */
        nav ul li a {
            color: white;
            text-decoration: none;
            font-weight: 500;
            padding: 0.2rem 1rem 0.3rem 1rem;
            border-radius: 40px;
            transition: background 0.3s ease, transform 0.2s ease;
        }

        nav ul li a:hover {
            color: rgb(49, 68, 72);
            transform: scale(1.1);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .news-container {
            /* Make scrollbar smaller */
            scrollbar-width: thin;
            /* Customize scrollbar color */
            scrollbar-color: rgba(59, 130, 246, 0.8) transparent;
        }

        .news-container::-webkit-scrollbar {
            width: 8px;
            /* Make scrollbar smaller */
            padding-right: 10px;
        }

        .news-container::-webkit-scrollbar-thumb {
            background-color: rgba(59, 130, 246, 0.8);
            /* Customize scrollbar thumb color */
            border-radius: 4px;
        }

        .news-container::-webkit-scrollbar-track {
            background: transparent;
            /* Customize scrollbar track color */
        }

        .ai-output {
            font-family: 'DM Sans', sans-serif; /* Apply DM Sans only to AI output */
        }

        /* ************************ Debt Planner Styles ************************ */
        .debt-plan-ai-output {
            font-family: 'DM Sans', sans-serif; /* Apply DM Sans only to AI output in Debt Planner */
        }

        /* ************************ News Content Scrollbar Styles ************************ */
        #news-content {
            max-height: 400px; /* Set a maximum height for scrolling */
            overflow-y: auto;
            scrollbar-width: thin; /* Make scrollbar smaller */
            scrollbar-color: rgba(59, 130, 246, 0.8) transparent; /* Customize scrollbar color */
        }

        #news-content::-webkit-scrollbar {
            width: 8px; /* Make scrollbar smaller */
            padding-right: 10px;
        }

        #news-content::-webkit-scrollbar-thumb {
            background-color: rgba(59, 130, 246, 0.8); /* Customize scrollbar thumb color */
            border-radius: 4px;
        }

        #news-content::-webkit-scrollbar-track {
            background: transparent; /* Customize scrollbar track color */
        }
    </style>
</head>

<body>
    <!-- ************************ Header Section ************************ -->
    <header class="Navbartext-white py-4 shadow-md"
        style="background-color: rgba(24, 20, 71, 1); position: fixed; top: 0; width: 100%; z-index: 1000;">
        <div class="mx-auto flex max-w-7xl items-center justify-between">
            <h1 class="text-4xl font-extrabold relative">
                <span class="bg-clip-text text-transparent"
                    style="background-image: url('BG1.2.gif'); background-size: 100% 100%; background-clip: text; -webkit-background-clip: text;">Finance
                    Coach</span>
            </h1>
            <nav>
                <button id="menu-toggle" class="md:hidden text-white text-3xl focus:outline-none">
                    &#9776;
                </button>
                <ul id="menu" class="hidden md:flex space-x-2">
                    <li class="px-2.5 pb-1 pt-0.5"><a href="#home">Home</a></li>
                    <li class="px-2.5 pb-1 pt-0.5"><a href="#savings">Savings</a></li>
                    <li class="px-2.5 pb-1 pt-0.5"><a href="#debtPlan">Debt Plan</a></li>
                    <li class="px-2.5 pb-1 pt-0.5"><a href="#about">About us</a></li>
                </ul>
            </nav>
        </div>
    </header>
    <div style="height: 72px;"></div> <!-- Spacer to prevent content overlap -->

    <script>
        const menuToggle = document.getElementById('menu-toggle');
        const menu = document.getElementById('menu');

        menuToggle.addEventListener('click', () => {
            menu.classList.toggle('hidden');
            menu.classList.toggle('flex');
            menu.classList.toggle('flex-col');
            menu.classList.toggle('absolute');
            menu.classList.toggle('top-0'); // Pin menu to the top
            menu.classList.toggle('right-0');
            menu.classList.toggle('bg-blue-900');
            menu.classList.toggle('p-4');
            menu.classList.toggle('rounded-lg');
            menu.classList.toggle('z-50'); // Ensure menu is above other elements
        });

        menu.querySelectorAll('a').forEach(link => {
            link.addEventListener('click', () => {
                menu.classList.add('hidden');
                menu.classList.remove('flex');
            });
        });
    </script>

    <hr class="glowing-hr mb-0 mx-auto w-full" style="position: fixed; z-index: 1000;">

    <!-- ************************ Chatbot and Financial News Section ************************ -->
    <div class="container mx-auto px-10 pt-20 flex flex-col md:flex-row gap-0">
        <!-- Chatbot Section -->
        <div class="chat-container bg-blue-100 hover:shadow-blue-400 hover:scale-105 transition-all duration-500 flex-1 md:w-[52%] max-w-[600px] h-[500px] mx-auto">
            <h1 class="text-3xl font-bold text-center mb-2 mt-6 text-blue-600">AI Personal Finance Coach</h1>
            <div id="chat-messages" class="chat-messages bg-blue-100">
                <div class="suggested-questions mt-4 p-4 border rounded-lg bg-gray-100 shadow">
                    <h2 class="text-sm font-semibold mb-2">Suggested Questions</h2>
                    <div class="flex flex-col gap-2">
                        <button class="b1 px-3 py-1 bg-emerald-500 text-white rounded-full w-fit"
                            onclick="searchAIChat('How can I save more money?')">How can I save more money?</button>
                        <button class="b2 px-3 py-1 bg-blue-500 text-white rounded-full  w-fit"
                            onclick="searchAIChat('What is the best way to invest?')">What is the best way to
                            invest?</button>
                        <button class="b1 px-3 py-1 bg-emerald-500 text-white rounded-full  w-fit"
                            onclick="searchAIChat('How do I create a budget?')">How do I create a budget?</button>
                        <button class="b2 px-3 py-1 bg-blue-500 text-white rounded-full w-fit"
                            onclick="searchAIChat('What are some tips for reducing debt?')">What are some tips for
                            reducing debt?</button>
                        <button class="b1 px-3 py-1 bg-emerald-500 text-white rounded-full w-fit"
                            onclick="searchAIChat('How can I improve my credit score?')">How can I improve my credit
                            score?</button>
                    </div>
                </div>
            </div>
            <div class="chat-input" style="position: absolute; bottom: 0; width: 100%; box-sizing: border-box;">
                <input id="user-input" type="text" placeholder="Type your message...">
                <button id="send-button">Send</button>
            </div>
        </div>

        <!-- Financial News Section -->
        <div class="news-container bg-blue-100 hover:shadow-blue-400 hover:scale-105 transition-all duration-500 flex-1 md:w-[52%] max-w-[600px] min-h-[500px] mx-auto"
            style="max-height: 500px; overflow-y: auto;">
            <div class="flex items-center justify-between px-4">
                <h2 class="text-3xl font-bold text-center mb-2 mt-6 text-blue-600 flex-1">Financial News</h2>
                <button id="refresh-news" class="text-blue-600 hover:text-blue-800 text-2xl mt-6">
                    &#x21bb; <!-- Unicode for refresh symbol -->
                </button>
            </div>
            <div id="news-content" class="space-y-4">
                <p class="text-gray-700 text-center">Click the refresh icon to load financial news.</p>
            </div>
        </div>

        <script>
            async function fetchFinancialNews() {
                const newsContainer = document.getElementById('news-content');
                newsContainer.innerHTML = `<p class="text-gray-700 text-center">Loading financial news...</p>`;
                try {
                    // const response = await fetch('https://api.marketaux.com/v1/news/all?countries=in&filter_entities=true&limit=10&published_after=2025-04-12T19:14&api_token=sVHCbJSP8HCHLH8JbdmBSJDYEKYuof6alWvG4C1K');
                    const response = await fetch('https://api.marketaux.com/v1/news/all?countries=in&filter_entities=true&limit=10&published_after=2025-04-12T19:14&api_token=P6Vf8E6GtzKsm9oS7ediHO5bUJ26TxvPClm7A97H');

                    // const response = await fetch('https://www.alphavantage.co/query?function=TIME_SERIES_INTRADAY&symbol=IBM&interval=5min&apikey=AGCBBJAG8JH7O8BZ&datatype=json');

                    if (!response.ok) {
                        throw new Error('Failed to fetch news');
                    }
                    const newsData = await response.json();
                    newsContainer.innerHTML = newsData.data.map(article => `
                        <div class="p-4 border-b">
                            <h3 class="text-lg font-semibold text-blue-600">${article.title}</h3>
                            <p class="text-sm text-gray-700">${article.description || 'No description available.'}</p>
                            <a href="${article.url}" target="_blank" class="text-blue-500 hover:underline">Read more</a>
                        </div>
                    `).join('');
                } catch (error) {
                    newsContainer.innerHTML = `<p class="text-red-500 text-center">Failed to load financial news. Please try again later.</p>`;
                    console.error('Error fetching financial news:', error);
                }
            }

            document.getElementById('refresh-news').addEventListener('click', fetchFinancialNews);
        </script>
    </div>

    <hr class="hr1 mt-20 border-t-1 border-slate-700 mx-auto w-full">

    <!-- ************************ About Us Section ************************ -->
    <div id="about-us-home" class="about-container bg-blue-50 px-20 py-2 shadow-md"
        style="background-color:rgba(24, 20, 71, 1);">
        <h2 class="text-2xl font-bold mb-3 text-center text-blue-50">About Us</h2>
        <p class="text-sm text-gray-100 mb-3">We are dedicated to helping you manage your finances effectively. Our
            mission is to provide tools and resources to empower you in making informed financial decisions.</p>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-9">
            <div>
                <h3 class="text-base font-semibold text-blue-600">Our Vision</h3>
                <p class="text-sm text-gray-100">To be the leading platform for personal finance management, enabling
                    individuals to achieve financial freedom.</p>
            </div>
            <div>
                <h3 class="text-base font-semibold text-blue-600">Our Mission</h3>
                <p class="text-sm text-gray-100">To provide innovative tools and expert advice that simplify financial
                    planning and decision-making.</p>
            </div>
        </div>
        <div class="mt-3">
            <h3 class="text-base font-semibold text-blue-600">Contact Us</h3>
            <form action="https://formspree.io/f/xdkejkzp" method="POST"
                class="mt-2 grid grid-cols-1 md:grid-cols-2 gap-9" id="contact-form">
                <div class="mb-3">
                    <label for="name" class="block text-sm text-gray-100 font-medium">Name:</label>
                    <input type="text" name="name" id="name"
                        class="w-full p-2 border border-gray-300 rounded min-w-[150px]" placeholder="Your Name" required>
                </div>
                <div class="mb-3">
                    <label for="email" class="block text-sm text-gray-100 font-medium">Email:</label>
                    <input type="email" name="email" id="email"
                        class="w-full p-2 border border-gray-300 rounded min-w-[150px]" placeholder="Your Email" required>
                </div>
                <div class="mb-3 col-span-2">
                    <label for="message" class="block text-sm text-gray-100 font-medium">Message:</label>
                    <textarea name="message" id="message"
                        class="w-full p-2 border border-gray-300 rounded" rows="1" placeholder="Your Message"
                        required></textarea>
                </div>
                <div class="col-span-2 text-center">
                    <button type="submit" class="bg-blue-500 text-white px-3 py-1.5 rounded hover:bg-blue-600">Send
                        Message</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ************************ Savings Section ************************ -->
    <div id="savings" class="section p-6 shadow-md mt-6"
        style="background-color: rgb(219 234 254 / var(--tw-bg-opacity, 1)); border-radius: 16px; max-width: 50%; margin: 0 auto;">
        <h2 class="text-3xl font-bold mb-4 text-center text-blue-700">Savings Calculator</h2>
        <p class="text-base text-gray-700 mb-4 text-center">Calculate how long it will take to reach your savings goal.
        </p>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 items-baseline space-y-2">
            <div class="form-group">
                <label for="monthly-income" class="block text-gray-700 font-medium">Monthly Income:</label>
                <input type="number" id="monthly-income" class="w-full p-2 border border-gray-300 rounded"
                    placeholder="Enter your monthly income">
            </div>
            <div class="form-group">
                <label for="monthly-expenses" class="block text-gray-700 font-medium">Monthly Expenses:</label>
                <input type="number" id="monthly-expenses" class="w-full p-2 border border-gray-300 rounded"
                    placeholder="Enter your monthly expenses">
            </div>
            <div class="form-group">
                <label for="savings-goal" class="block text-gray-700 font-medium">Savings Goal:</label>
                <input type="number" id="savings-goal" class="w-full p-2 border border-gray-300 rounded"
                    placeholder="Enter your savings goal">
            </div>
            <div class="form-group">
                <label for="target-date" class="block text-gray-700 font-medium">Target Date (in months):</label>
                <input type="number" id="target-date" class="w-full p-2 border border-gray-300 rounded"
                    placeholder="Enter target date in months">
            </div>
        </div>
        <div class="text-center mt-4">
            <button onclick="calculateSavings()"
                class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">Calculate</button>
        </div>
        <div id="savings-result"
            class="result my-6 p-4 bg-green-50 border border-green-300 rounded text-green-700 text-center"></div>
    </div>

    <!-- ************************ Debt Plan Section ************************ -->
    <div id="debtPlan" class="section p-6 shadow-md mt-6"
        style="background-color: rgb(219 234 254 / var(--tw-bg-opacity, 1)); border-radius: 16px; max-width: 50%; margin: 0 auto 50px auto; min-width: 320px;">
        <h2 class="text-3xl font-bold mb-4 text-center text-blue-700">Debt Planner</h2>
        <p class="text-base text-gray-700 mb-4 text-center">Plan your debt repayment strategy effectively.</p>
        <form id="debt-form" class="space-y-2 grid grid-cols-1 md:grid-cols-2 gap-4 items-baseline">
            <div>
                <label for="debt-name" class="block text-gray-700 font-medium">Debt Name:</label>
                <input type="text" id="debt-name" name="debt_name" class="w-full p-2 border border-gray-300 rounded"
                    placeholder="Enter debt name" required>
            </div>
            <div>
                <label for="balance" class="block text-gray-700 font-medium">Balance:</label>
                <input type="number" id="balance" name="balance" class="w-full p-2 border border-gray-300 rounded"
                    placeholder="Enter balance" required>
            </div>
            <div>
                <label for="interest-rate" class="block text-gray-700 font-medium">Interest Rate (%):</label>
                <input type="number" id="interest-rate" name="interest_rate"
                    class="w-full p-2 border border-gray-300 rounded" placeholder="Enter interest rate" required>
            </div>
            <div>
                <label for="minimum-payment" class="block text-gray-700 font-medium">Minimum Payment:</label>
                <input type="number" id="minimum-payment" name="minimum_payment"
                    class="w-full p-2 border border-gray-300 rounded" placeholder="Enter minimum payment" required>
            </div>
            <div>
                <label for="strategy" class="block text-gray-700 font-medium">Strategy:</label>
                <select id="strategy" name="strategy" class="w-full p-2 border border-gray-300 rounded">
                    <option value="snowball">Snowball Method</option>
                    <option value="avalanche">Avalanche Method</option>
                </select>
            </div>
            <div>
                <label for="repayment-date" class="block text-gray-700 font-medium">Target Repayment Date
                    (Optional):</label>
                <input type="date" id="repayment-date" name="repayment_date"
                    class="w-full p-2 border border-gray-300 rounded">
            </div>
            <div class="text-center mt-4 col-span-2 flex justify-center items-center">
                <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">Generate
                    Plan</button>
            </div>
        </form>
        <div id="debt-plan-result" class="my-6 p-4 bg-green-50 border border-green-300 rounded text-green-700"></div>
    </div>

    <!-- ************************ Scripts Section ************************ -->
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const debtForm = document.getElementById('debt-form');
            const resultsContainer = document.getElementById('debt-plan-results-container') || document.createElement('div');
            resultsContainer.id = 'debt-plan-results-container';
            debtForm.parentNode.insertBefore(resultsContainer, debtForm.nextSibling);

            debtForm.addEventListener('submit', async function (e) {
                e.preventDefault();

                const debtData = {
                    debt_name: document.getElementById('debt-name').value,
                    balance: parseFloat(document.getElementById('balance').value),
                    interest_rate: parseFloat(document.getElementById('interest-rate').value),
                    minimum_payment: parseFloat(document.getElementById('minimum-payment').value),
                    strategy: document.getElementById('strategy').value,
                    repayment_date: document.getElementById('repayment-date').value || null
                };

                try {
                    const aiResponse = await getGeminiResponse(`
                    You are a personal finance expert. Please generate a debt repayment strategy based on the following details:
                    Debt Name: ${debtData.debt_name},
                    Balance: ${debtData.balance},
                    Interest Rate: ${debtData.interest_rate}%,
                    Minimum Payment: ${debtData.minimum_payment},
                    Strategy: ${debtData.strategy},
                    Target Repayment Date: ${debtData.repayment_date || 'Not specified'}. Please format the response with markdown-like syntax for emphasis (using '*') and newlines where appropriate for readability. Be clear and concise. Don't exceed 150 words. Note: All transactions are in INR.
                `);

                    const debtPlanDiv = document.createElement('div');
                    debtPlanDiv.classList.add('mb-4', 'p-4', 'border', 'border-gray-300', 'rounded-md');

                    const heading = document.createElement('h3');
                    heading.classList.add('text-lg', 'font-bold', 'mb-2');
                    heading.textContent = `Debt: ${debtData.debt_name}`;

                    const formattedResponse = cleanGeminiOutput(aiResponse);
                    const responseElement = document.createElement('div');
                    responseElement.classList.add('debt-plan-ai-output', 'mb-2');
                    responseElement.innerHTML = `<strong>AI Coach:</strong> ${formattedResponse}`;

                    const detailsList = document.createElement('ul');
                    detailsList.classList.add('list-disc', 'ml-5', 'mt-2');
                    detailsList.innerHTML = `
                    <li><span class="font-semibold">Balance:</span> ₹${debtData.balance}</li>
                    <li><span class="font-semibold">Interest Rate:</span> ${debtData.interest_rate}%</li>
                    <li><span class="font-semibold">Minimum Payment:</span> ₹${debtData.minimum_payment}</li>
                    <li><span class="font-semibold">Strategy Type:</span> ${debtData.strategy}</li>
                    ${debtData.repayment_date ? `<li><span class="font-semibold">Target Date:</span> ${debtData.repayment_date}</li>` : ''}
                `;

                    debtPlanDiv.appendChild(heading);
                    debtPlanDiv.appendChild(responseElement);
                    debtPlanDiv.appendChild(detailsList);

                    resultsContainer.appendChild(debtPlanDiv);

                } catch (error) {
                    const errorDiv = document.createElement('div');
                    errorDiv.classList.add('text-red-500', 'mb-4');
                    errorDiv.textContent = `Error fetching strategy for ${debtData.debt_name}: ${error.message}`;
                    resultsContainer.appendChild(errorDiv);
                }
            });
        });

        function cleanGeminiOutput(rawText) {
            // Replace \n with actual newlines
            let formatted = rawText.replace(/\\n/g, '<br>');

            // Replace multiple spaces with a single space
            formatted = formatted.replace(/\s{2,}/g, ' ');

            // Convert bold syntax **text** to <strong>text</strong>
            formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');

            // Convert italic syntax *text* to <em>text</em>
            formatted = formatted.replace(/\*(.*?)\*/g, '<em>$1</em>');

            // Replace points * with a dot (•)
            formatted = formatted.replace(/^\* (.*?)/gm, '• $1');

            return formatted.trim();
        }
    </script>



    <script>
        function cleanGeminiOutput(rawText) {
            // Replace \n with actual newlines
            let formatted = rawText.replace(/\\n/g, '<br>');

            // Replace multiple spaces with a single space
            formatted = formatted.replace(/\s{2,}/g, ' ');

            // Convert bold syntax **text** to <strong>text</strong>
            formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');

            // Convert italic syntax *text* to <em>text</em>
            formatted = formatted.replace(/\*(.*?)\*/g, '<em>$1</em>');

            // Replace points * with a dot (•)
            formatted = formatted.replace(/^\* (.*?)/gm, '• $1');

            return formatted.trim();
        }

        async function addMessageToChat(sender, message) {
            const messageElement = document.createElement('div');
            messageElement.classList.add('mb-2');

            const formattedMessage = cleanGeminiOutput(message);
            const senderClass = sender === 'AI Coach' ? 'ai-output' : '';
            messageElement.innerHTML = `<strong>${sender}:</strong> <span class="${senderClass}">${formattedMessage}</span>`;
            chatMessages.appendChild(messageElement);
            chatMessages.scrollTop = chatMessages.scrollHeight;

            chatHistory.push({ sender, message });
        }

        const chatMessages = document.getElementById('chat-messages');
        const userInput = document.getElementById('user-input');
        const sendButton = document.getElementById('send-button');

        const GEMINI_API_KEY = 'AIzaSyD6sPgQnOcTuU8owVF3weVEek-e2od9kEw';
        const GEMINI_API_URL = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent';

        let chatHistory = [];

        async function loadChatHistory() {
            try {
                const response = await fetch('api/storage.php?action=load&type=chat_history');
                if (!response.ok) {
                    throw new Error(`Failed to load chat history: ${response.status} ${response.statusText}`);
                }
                const history = await response.json();
                chatHistory = history || [];

                chatHistory.forEach(chat => {
                    addMessageToChat(chat.sender, chat.message);
                });
            } catch (error) {
                console.error('Error loading chat history:', error);
            }
        }

        async function saveChatHistory() {
            try {
                const response = await fetch('api/storage.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'save',
                        type: 'chat_history',
                        data: chatHistory
                    })
                });

                if (!response.ok) {
                    throw new Error(`Failed to save chat history: ${response.status} ${response.statusText}`);
                }
            } catch (error) {
                console.error('Error saving chat history:', error);
            }
        }

        async function getGeminiResponse(message) {
            try {
                const response = await fetch(`${GEMINI_API_URL}?key=${GEMINI_API_KEY}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: `You are a personal finance expert. Please provide clear, concise, and accurate advice about personal finance. Please format the response with markdown-like syntax for emphasis, strong, points and newlines where appropriate for readability:
                                - **Bold text** for emphasis.
                                - *Italic text* for highlights.
                                - Use * for points.
                                - Use \\n for new lines.
                                Ensure the output adheres to these rules strictly.\nThe user's question is: ${message}`
                            }]
                        }],
                        generationConfig: {
                            temperature: 0.7,
                            topK: 40,
                            topP: 0.95,
                            maxOutputTokens: 1024,
                        },
                        safetySettings: [
                            {
                                category: "HARM_CATEGORY_HARASSMENT",
                                threshold: "BLOCK_MEDIUM_AND_ABOVE"
                            },
                            {
                                category: "HARM_CATEGORY_HATE_SPEECH",
                                threshold: "BLOCK_MEDIUM_AND_ABOVE"
                            },
                            {
                                category: "HARM_CATEGORY_SEXUALLY_EXPLICIT",
                                threshold: "BLOCK_MEDIUM_AND_ABOVE"
                            },
                            {
                                category: "HARM_CATEGORY_DANGEROUS_CONTENT",
                                threshold: "BLOCK_MEDIUM_AND_ABOVE"
                            }
                        ]
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error('API Error:', errorData);
                    throw new Error(`API Error: ${response.status} ${response.statusText}. Error data: ${JSON.stringify(errorData)}`);
                }

                const data = await response.json();

                if (!data.candidates || !data.candidates[0] || !data.candidates[0].content) {
                    throw new Error('Invalid API response format');
                }

                return data.candidates[0].content.parts[0].text;
            } catch (error) {
                console.error('Error getting Gemini response:', error);
                throw error;
            }
        }

        async function handleUserInput() {
            const message = userInput.value.trim();
            if (message) {
                addMessageToChat('You', message);
                userInput.value = '';

                try {
                    const loadingMessage = addMessageToChat('AI Coach', 'Thinking...');

                    const response = await getGeminiResponse(message);

                    if (loadingMessage && loadingMessage.parentNode) {
                        loadingMessage.remove();
                    }

                    addMessageToChat('AI Coach', response);

                    await saveChatHistory();
                } catch (error) {
                    console.error('Error getting AI response:', error);

                    if (loadingMessage && loadingMessage.parentNode) {
                        loadingMessage.remove();
                    }

                    addMessageToChat('AI Coach', 'Sorry, I encountered an error. Please try again. If the problem persists, please check your internet connection and try again later.');
                }
            }
        }

        document.addEventListener('DOMContentLoaded', loadChatHistory);

        sendButton.addEventListener('click', handleUserInput);

        userInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                handleUserInput();
            }
        });

        function searchAIChat(question) {
            const userInput = document.getElementById('user-input');
            userInput.value = question;
            document.getElementById('send-button').click();
        }

        const sections = document.querySelectorAll('.section');
        const navLinks = document.querySelectorAll('nav a');

        navLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const targetId = link.getAttribute('href').substring(1);

                sections.forEach(section => {
                    section.style.display = section.id === targetId ? 'block' : 'none';
                });

                const chatContainer = document.querySelector('.chat-container');
                const newsContainer = document.querySelector('.news-container');
                const aboutUsHome = document.getElementById('about-us-home');
                if (targetId === 'savings' || targetId === 'debtPlan') {
                    chatContainer.style.display = 'none';
                    newsContainer.style.display = 'none';
                    chatContainer.style.margin = '0 auto';
                    chatContainer.style.padding = '0';
                    aboutUsHome.style.display = 'none';
                } else {
                    chatContainer.style.display = 'block';
                    newsContainer.style.display = 'block';
                    chatContainer.style.margin = '0 auto';
                    chatContainer.style.padding = '0';
                    aboutUsHome.style.display = 'block';
                }

                const hrElements = document.querySelectorAll('.hr1');
                if (targetId === 'savings' || targetId === 'debtPlan') {
                    hrElements.forEach(element => {
                        element.style.display = 'none';
                    });
                } else {
                    hrElements.forEach(element => {
                        element.style.display = 'block';
                    });
                }

                if (targetId === 'about') {
                    window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
                }
            });
        });

        function calculateSavings() {
            const monthlyIncome = parseFloat(document.getElementById('monthly-income').value);
            const monthlyExpenses = parseFloat(document.getElementById('monthly-expenses').value);
            const savingsGoal = parseFloat(document.getElementById('savings-goal').value);
            const targetDate = parseFloat(document.getElementById('target-date').value);

            if (isNaN(monthlyIncome) || isNaN(monthlyExpenses) || isNaN(savingsGoal) || isNaN(targetDate)) {
                document.getElementById('savings-result').innerText = '❌ Please fill in all fields correctly.';
                return;
            }

            const monthlySavings = monthlyIncome - monthlyExpenses;

            if (monthlySavings <= 0) {
                document.getElementById('savings-result').innerText = '❌ Your expenses exceed or equal your income. Savings are not possible.';
                return;
            }

            const monthsNeeded = savingsGoal / monthlySavings;

            if (monthsNeeded > targetDate) {
                document.getElementById('savings-result').innerText = `❌ You cannot reach your savings goal within ${targetDate} months. You need approximately ${Math.ceil(monthsNeeded)} months.`;
            } else {
                document.getElementById('savings-result').innerText = `✅ You can reach your savings goal of ₹${savingsGoal} in ${Math.ceil(monthsNeeded)} months.`;
            }
        }

        
        sections.forEach(section => section.style.display = section.id === 'home' ? 'block' : 'none');
    </script>

    <script>
        // Thank you popup for Formspree contact form
        document.addEventListener('DOMContentLoaded', function () {
            const contactForm = document.getElementById('contact-form');
            if (contactForm) {
                contactForm.addEventListener('submit', function (e) {
                    e.preventDefault();
                    const formData = new FormData(contactForm);
                    fetch(contactForm.action, {
                        method: 'POST',
                        body: formData,
                        headers: { 'Accept': 'application/json' }
                    }).then(response => {
                        if (response.ok) {
                            contactForm.reset();
                        } else {
                            // alert removed
                        }
                    }).catch(() => {
                        // alert removed
                    });
                });
            }
        });
    </script>

    <!-- Thank You Modal -->
    <div id="thankyou-modal" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-40 z-50 hidden">
        <div class="bg-white rounded-lg shadow-lg p-8 max-w-sm w-full text-center">
            <h2 class="text-2xl font-bold mb-4 text-green-600">Thank You!</h2>
            <p class="mb-6 text-gray-700">Thank you for contacting us! We will get back to you soon.</p>
            <button id="close-thankyou-modal" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">Close</button>
        </div>
    </div>

    <script>
        // Thank you popup for Formspree contact form (centered modal)
        document.addEventListener('DOMContentLoaded', function () {
            const contactForm = document.getElementById('contact-form');
            const thankyouModal = document.getElementById('thankyou-modal');
            const closeThankyouModal = document.getElementById('close-thankyou-modal');
            if (contactForm) {
                contactForm.addEventListener('submit', function (e) {
                    e.preventDefault();
                    const formData = new FormData(contactForm);
                    fetch(contactForm.action, {
                        method: 'POST',
                        body: formData,
                        headers: { 'Accept': 'application/json' }
                    }).then(response => {
                        if (response.ok) {
                            thankyouModal.classList.remove('hidden');
                            contactForm.reset();
                        } 
                        // Removed browser alert popups for both success and error
                    }).catch(() => {
                        // No alert on error, optionally handle error UI here
                    });
                });
            }
            if (closeThankyouModal && thankyouModal) {
                closeThankyouModal.addEventListener('click', function () {
                    thankyouModal.classList.add('hidden');
                });
            }
        });
    </script>
</body>
</html>
